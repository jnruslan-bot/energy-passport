<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç</title>

<style>
table {
  border-collapse: collapse;
  min-width: 1600px;
}

th, td {
  border: 1px solid #666;
  text-align: center;
  padding: 4px;
}

input, select {
  width: 95%;
}

/* ===== –ü–ê–†–ê–ú–ï–¢–†–´ –ó–î–ê–ù–ò–Ø ===== */

.params-box {
  display: flex;
  gap: 40px;
  align-items: flex-end;
  padding: 12px;
  background: #f5f5f5;
  border: 1px dashed #999;
}

.param-field {
  display: flex;
  flex-direction: column;
  min-width: 280px;
}

.param-field label {
  font-size: 13px;
  margin-bottom: 4px;
  color: #333;
}

.param-field select {
  padding: 4px;
}
</style>

</head>

<body>
<div style="margin-bottom: 12px;">
  <button onclick="location.href='dashboard.html'">‚Üê –ù–∞–∑–∞–¥</button>
  <button onclick="location.href='index.html'">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</div>

<h1>–≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç ‚Äî –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</h1>
<button id="addRowBtn">Ôºã –î–æ–±–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
<button onclick="exportExcel()">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
<button onclick="exportPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
<div style="overflow-x:auto">
<table>
<thead>
  <tr>
    <th rowspan="2">‚Ññ<br>–ø/–ø</th>
    <th rowspan="2">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ / –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è</th>
    <th rowspan="2">–ì–æ–¥ –≤–≤–æ–¥–∞ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é / –∏–∑–Ω–æ—Å, %</th>
    <th rowspan="2">–û—Ç–∞–ø–ª–∏–≤–∞–µ–º–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤</th>
    <th rowspan="2">–ü–µ—Ä–∏–º–µ—Ç—Ä, –º</th>
    <th rowspan="2">–í—ã—Å–æ—Ç–∞, –º</th>
    <th rowspan="2">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C</th>

    <th colspan="4">
      –ü—Ä–∏–≤–µ–¥—ë–Ω–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–ª–æ–ø–µ—Ä–µ–¥–∞—á–µ, –º¬≤¬∑¬∞C/–í—Ç
    </th>

    <th colspan="2">
      –£–¥–µ–ª—å–Ω–∞—è –æ—Ç–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞, –í—Ç/–º¬≥¬∑¬∞C
    </th>

    <th colspan="2">
      –°—É–º–º–∞—Ä–Ω—ã–π –≥–æ–¥–æ–≤–æ–π —Ä–∞—Å—Ö–æ–¥ —Ç–µ–ø–ª–æ–≤–æ–π —ç–Ω–µ—Ä–≥–∏–∏, –ì–∫–∞–ª/–≥–æ–¥
    </th>

    <th rowspan="2">
      –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ (—Ä–∞—Å—á—ë—Ç–Ω–æ–≥–æ) –∑–Ω–∞—á–µ–Ω–∏—è<br>
      —É–¥–µ–ª—å–Ω–æ–π –æ—Ç–æ–ø–∏—Ç–µ–ª—å–Ω–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ—Ç –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–π, %
    </th>

    <th rowspan="2">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</th>
  </tr>

  <tr>
    <th>–°—Ç–µ–Ω—ã</th>
    <th>–ü–æ–ª</th>
    <th>–ü–æ–∫—Ä—ã—Ç–∏–µ</th>
    <th>–û–∫–Ω–∞</th>

    <th>–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è<br>(—Ä–∞—Å—á—ë—Ç–Ω–∞—è)</th>
    <th>–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è</th>

    <th>–ù–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ<br>–∏ –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—é</th>
    <th>–ù–∞ —Å–∏—Å—Ç–µ–º—É –ì–í–°</th>
  </tr>
</thead>


<tbody id="industrialBody"></tbody>
</table>
</div>

<script type="module">
import { cities, qNormTable, rNormTable } from "./data/reference-data.js";

import {
  getQnorm,
  calculateQFact,
  calculateBuildingVolume,
  calculateHeatingEnergy,
  calculateHotWaterEnergy,
  calculateRpr              // ‚Üê –î–û–ë–ê–í–ò–õ–ò
} from "./calc/calc/heat-calculations.js";



const tbody = document.getElementById("industrialBody");
let rowCount = 0;

// ===============================
// –ü–µ—Ä–µ—Å—á—ë—Ç —Å—Ç—Ä–æ–∫–∏
// ===============================
function recalcRow(row) {
  const cityName = row.dataset.city;
  if (!cityName) return;

  const city = cities.find(c => c.name === cityName);
  if (!city) return;

  const qNormCell = row.querySelector('[data-col="qNorm"]');
  const qFactCell = row.querySelector('[data-col="qFact"]');
  const QheatCell = row.querySelector('[data-col="Qheat"]');

  const qNorm = parseFloat(qNormCell.textContent);
  const deviation = parseFloat(
    row.querySelector('[data-col="deviation"] input')?.value
  );

  if (!Number.isFinite(qNorm)) return;
  const qFact = calculateQFact(qNorm, deviation);
  if (!Number.isFinite(qFact)) return;

  qFactCell.textContent = qFact.toFixed(2);
// ===== R–ø—Ä =====
const purpose = row.dataset.purpose;

const rCells = {
  walls:   row.children[7],   // –°—Ç–µ–Ω—ã
  floor:   row.children[8],   // –ü–æ–ª
  roof:    row.children[9],   // –ü–æ–∫—Ä—ã—Ç–∏–µ
  windows: row.children[10]   // –û–∫–Ω–∞
};

if (purpose) {
  const R = calculateRpr({
    purpose,
    qNorm,
    qFact,
    rNormTable
  });

  if (R) {
    rCells.walls.textContent   = R.walls.toFixed(2);
    rCells.floor.textContent   = R.floor.toFixed(2);
    rCells.roof.textContent    = R.roof.toFixed(2);
    rCells.windows.textContent = R.windows.toFixed(2);
  }
}

  const area = parseFloat(
    row.querySelector('[data-col="area"] input')?.value
  );
  const height = parseFloat(
    row.querySelector('[data-col="height"] input')?.value
  );

  const volume = calculateBuildingVolume(area, height);
  if (!Number.isFinite(volume)) return;
// ===== –û–¢–û–ü–õ–ï–ù–ò–ï =====
const Qheat = calculateHeatingEnergy({
  qFact,
  volume,
  gsop: city.gsop
});

if (Number.isFinite(Qheat)) {
  QheatCell.textContent = Qheat.toFixed(2);
}

  // ===== –ì–í–° =====
const QgvsCell = row.querySelector('[data-col="Qgvs"]');

const Qgvs = calculateHotWaterEnergy({
  area
});

if (Number.isFinite(Qgvs)) {
  QgvsCell.textContent = Qgvs.toFixed(2);
}

}
function collectFilledRows() {
  const rows = [];

  document.querySelectorAll("#industrialBody tr").forEach(row => {
    const area = row.querySelector('[data-col="area"] input')?.value;
    if (!area || Number(area) <= 0) return;

    const get = col =>
      row.querySelector(`[data-col="${col}"]`)?.textContent?.trim() || "";

    const getInput = col =>
      row.querySelector(`[data-col="${col}"] input`)?.value || "";

    rows.push({
      "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è": row.children[1].querySelector("input")?.value || "",
      "–ì–æ–¥ / –∏–∑–Ω–æ—Å": row.children[2].querySelector("input")?.value || "",
      "–ü–ª–æ—â–∞–¥—å, –º¬≤": area,
      "–ü–µ—Ä–∏–º–µ—Ç—Ä, –º": row.children[4].querySelector("input")?.value || "",
      "–í—ã—Å–æ—Ç–∞, –º": row.children[5].querySelector("input")?.value || "",
      
      "R —Å—Ç–µ–Ω—ã": row.children[7].textContent,
      "R –ø–æ–ª": row.children[8].textContent,
      "R –ø–æ–∫—Ä—ã—Ç–∏–µ": row.children[9].textContent,
      "R –æ–∫–Ω–∞": row.children[10].textContent,

      "q —Ñ–∞–∫—Ç": get("qFact"),
      "q –Ω–æ—Ä–º": get("qNorm"),

      "Q –æ—Ç–æ–ø–ª–µ–Ω–∏–µ, –ì–∫–∞–ª/–≥–æ–¥": get("Qheat"),
      "Q –ì–í–°, –ì–∫–∞–ª/–≥–æ–¥": get("Qgvs"),

      "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, %": getInput("deviation")
    });
  });

  return rows;
}
function exportExcel() {
  const data = collectFilledRows();

  if (!data.length) {
    alert("–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏");
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);

  ws["!cols"] = Object.keys(data[0]).map(key => ({
    wch: Math.min(
      Math.max(key.length, ...data.map(r => String(r[key]).length)) + 2,
      40
    )
  }));

  ws["!freeze"] = { ySplit: 1 };

  XLSX.utils.book_append_sheet(wb, ws, "–≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç");

  const date = new Date().toISOString().slice(0, 10);
  XLSX.writeFile(wb, `–≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç_${date}.xlsx`);
}
function exportPDF() {
  const rows = collectFilledRows();
  if (!rows.length) {
    alert("–ù–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏");
    return;
  }

  const table = document.querySelector("table").cloneNode(true);
// ‚ùå –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü (–ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
table.querySelectorAll("tr").forEach(tr => {
  tr.lastElementChild?.remove();
});

  // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
  table.querySelectorAll("tbody tr").forEach(tr => {
    const area = tr.querySelector('[data-col="area"] input')?.value;
    if (!area || Number(area) <= 0) tr.remove();
  });

  // input ‚Üí span
  table.querySelectorAll("input, button").forEach(el => {
    const span = document.createElement("span");
    span.textContent = el.value || "";
    el.replaceWith(span);
  });

  // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–¢–ò–õ–ò –î–õ–Ø PDF
  table.style.width = "100%";
  table.style.minWidth = "0";
  table.style.fontSize = "8.5px";
  table.style.tableLayout = "fixed";

  const wrapper = document.createElement("div");
  wrapper.style.padding = "5px";
  wrapper.innerHTML = `
    <h2 style="text-align:center; margin-bottom:8px">
      –≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç ‚Äî –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
    </h2>
  `;
  wrapper.appendChild(table);

  const opt = {
    margin: [3, 3, 3, 3],
    filename: `–≠–Ω–µ—Ä–≥–æ–ø–∞—Å–ø–æ—Ä—Ç_${new Date().toISOString().slice(0,10)}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
  };

  html2pdf().set(opt).from(wrapper).save();
}

// ===============================
// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
// ===============================
function addRow() {
  rowCount++;

  const tr = document.createElement("tr");
  tr.innerHTML = `
  <td>${rowCount}</td>

  <td><input placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–¥–∞–Ω–∏—è"></td>
  <td><input placeholder="–ì–æ–¥ / –∏–∑–Ω–æ—Å %"></td>

  <td data-col="area"><input type="number"></td>
  <td><input type="number"></td>
  <td data-col="height"><input type="number"></td>
  <td data-col="tInside"><input type="number"></td>

  <!-- R–ø—Ä -->
  <td></td> <!-- —Å—Ç–µ–Ω—ã -->
  <td></td> <!-- –ø–æ–ª -->
  <td></td> <!-- –ø–æ–∫—Ä—ã—Ç–∏–µ -->
  <td></td> <!-- –æ–∫–Ω–∞ -->

  <!-- q -->
  <td data-col="qFact"></td>
  <td data-col="qNorm"></td>

  <!-- Q–≥–æ–¥ -->
  <td data-col="Qheat"></td>
  <td data-col="Qgvs"></td>


  <td data-col="deviation"><input type="number"></td>

 <td>
  <button type="button" class="btn-params">‚öô</button>
  <button type="button" class="btn-delete">‚úñ</button>
</td>

`;

  tbody.appendChild(tr);

  tr.querySelectorAll("input").forEach(i =>
    i.addEventListener("input", () => recalcRow(tr))
  );

  tr.querySelector(".btn-params").onclick = () => toggleParams(tr);

tr.querySelector(".btn-delete").onclick = () => {
  if (confirm("–£–¥–∞–ª–∏—Ç—å –∑–¥–∞–Ω–∏–µ?")) {
    const next = tr.nextElementSibling;
    if (next?.classList.contains("params-row")) next.remove();
    tr.remove();
  }
};

}

// ===============================
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–¥–∞–Ω–∏—è
// ===============================
function toggleParams(row) {
  let pRow = row.nextElementSibling;
  if (pRow?.classList.contains("params-row")) {
    pRow.remove();
    return;
  }

  pRow = document.createElement("tr");
  pRow.className = "params-row";
  pRow.innerHTML = `
    <td colspan="100%">
      <div class="params-box">
  <div class="param-field">
    <label>–ì–æ—Ä–æ–¥</label>
    <select class="city"></select>
  </div>

  <div class="param-field">
    <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ</label>
    <select class="purpose">
      <option>–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ</option>
      <option>–°–∫–ª–∞–¥—Å–∫–æ–µ</option>
      <option>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ-–±—ã—Ç–æ–≤–æ–µ</option>
      <option>–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ</option>
    </select>
  </div>
</div>

    </td>
  `;
  row.after(pRow);

  const citySel = pRow.querySelector(".city");
  cities.forEach(c => {
    const o = document.createElement("option");
    o.value = c.name;
    o.textContent = c.name;
    citySel.appendChild(o);
  });
// ===== –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ì–û–†–û–î –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ =====
citySel.selectedIndex = 0;
row.dataset.city = citySel.value;

const city = cities[0];
const purpose = pRow.querySelector(".purpose").value;
row.dataset.purpose = purpose;

// —Å—Ä–∞–∑—É —Å—á–∏—Ç–∞–µ–º q–Ω–æ—Ä–º
const qNorm = getQnorm({ city, purpose, qNormTable });

if (qNorm !== null) {
  row.querySelector('[data-col="qNorm"]').textContent = qNorm.toFixed(2);
}

  citySel.onchange = () => {
    row.dataset.city = citySel.value;
    const city = cities.find(c => c.name === citySel.value);
    const purpose = pRow.querySelector(".purpose").value;

    const qNorm = getQnorm({ city, purpose, qNormTable });
    if (qNorm !== null) {
      row.querySelector('[data-col="qNorm"]').textContent = qNorm.toFixed(2);
    }
    recalcRow(row);
  };

  pRow.querySelector(".purpose").onchange = e => {
    row.dataset.purpose = e.target.value;
    const city = cities.find(c => c.name === row.dataset.city);
    const qNorm = getQnorm({ city, purpose: e.target.value, qNormTable });
    if (qNorm !== null) {
      row.querySelector('[data-col="qNorm"]').textContent = qNorm.toFixed(2);
    }
    recalcRow(row);
  };
}

document.getElementById("addRowBtn").onclick = addRow;
addRow();
// üëá –¥–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–∑ HTML
window.exportExcel = exportExcel;
window.exportPDF   = exportPDF;
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

</body>
</html>
